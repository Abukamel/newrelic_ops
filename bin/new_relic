#!/usr/bin/env python
import click
import salt.config
import salt.client


def salt_init():
    opts = salt.config.apply_minion_config()
    opts['file_client'] = 'local'
    caller = salt.client.Caller(mopts=opts)
    return caller


@click.command()
@click.option('-i', '--install', help='Install new relic system monitor',
              is_flag=True)
@click.option('-k', '--key', help='new relic data access key', default=False)
def main(install, key):
    info = dict(
        newrelic_url='http://download.newrelic.com/pub/newrelic/el5/i386/\
                     newrelic-repo-5-3.noarch.rpm',
        newrelic_package='newrelic-sysmond',
        newrelic_license_cmd='nrsysmond-config --set license_key=%(l_key)s' % {'l_key': key}
        )
    if not install:
        click.echo('Try new_relic --help for useful information!')
    else:
        if not key:
            key = click.prompt('NewRelic data access key')
        caller = salt_init()
        caller.sminion.functions['pkg.install'](name=info['newrelic_url'])
        click.echo(('NewRelic repo has been added!'))
        caller.sminion.functions['pkg.install'](name=info['newrelic_package'],
                                                require=[{'pkg': info['newrelic_url']}])
        click.echo('%(nl_pkg)s has been installed!' % {'nl_pkg': info['newrelic_package']})
        caller.sminion.functions['cmd.run'](name=info[newrelic_license_cmd])


if __name__ == "__main__":
    main()